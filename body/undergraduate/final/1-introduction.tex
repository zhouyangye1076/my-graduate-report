\cleardoublepage

\section{绪论}

现代处理器为了追求极致的硬件性能，引入了大量复杂的投机执行技术\cite{gonzalez2010processor}。
这些技术会对未执行完毕的指令结果进行预测，便于后续指令可以提前执行，从而提高处理器执行效率和硬件利用率。
瞬态执行是指当处理器预测错误时发生的不该被执行的指令的临时执行行为。
当预测错误被发现时，处理器将回滚瞬态执行指令的执行结果，这虽然确保了处理器架构层的正确性，
但是仍会对部分微架构状态造成不可撤销的影响，因此可以采取特殊攻击技术从这些状态变化中恢复出处理器内部的安全敏感数据。
自Spectre\cite{kocher2020spectre}和 Meltdown\cite{horn2018meltdown} 等瞬态执行漏洞被披露以来，
各类瞬态执行漏洞如 ForeShadow\cite{van2018foreshadow}、CacheOut\cite{van2021cacheout}、
Ret2Spec\cite{maisuradze2018ret2spec}、RIDL\cite{mathure2023hardware}、
MDS\cite{minkin2019fallout}、FPVI\cite{ragab2021rage}不断涌现；
且因为瞬态执行漏洞利用最底层的硬件漏洞发动攻击，所以任何运行在 CPU 上的实体，
无论其特权级和工作模式，都有可能成为攻击者和受害者。这使得瞬态执行漏洞已经成为现代 CPU 中的关键问题。\par

虽然这些漏洞严重损害了 CPU 上软件的安全性，但受制于硬件漏洞的不可修复性，
各大厂商无法为已经出厂的芯片提供修复漏洞的办法，因此在 RTL 开发阶段发现瞬态执行漏洞，
并及时加以修复，就显得至关重要。随着软件模糊测试技术的不断成熟，该技术也被逐步应用于处理器漏洞挖掘，
并且已经发现了很多具有影响力的硬件功能性漏洞。但是因为瞬态执行漏洞本身语义的复杂性，
导致很难对瞬态执行攻击本身进行逻辑约束和测试程序生成。因此许多瞬态执行漏洞测试程序生成框架选择
忽略瞬态执行程序的语义信息，仅采用简单的随机生成的方式构造瞬态执行漏洞测试，
导致测试程序的有效性低下；而另一些生成框架则采用基于模板的方式构造某些瞬态漏洞的变体，
虽然可以较快地生成测试程序，但是覆盖的瞬态漏洞种类较为单一。
因此如何针对瞬态执行漏洞自动化生成有效且多样化的测试程序，仍然是瞬态漏洞模糊测试领域亟待解决的重要课题。\par

我们发现现有的瞬态执行漏洞测试程序生成框架存在以下问题：
第一，生成程序的数据流和控制流没有被很好地约束，随机指令生成导致程序很难触发内存访问错误、访问秘密数据等特殊事件，
进而导致满足瞬态执行要求的指令序列的生成效率极其低下。第二，现有的生成框架没有为瞬态窗口触发有意识地
生成训练代码，而多用随机的方式修改微架构的状态，导致瞬态窗口触发效率低下。第三，
整个瞬态执行程序的各个代码块之间是相互配合的，因此当各个代码块生成和排布的时候，
需要充分考虑协同工作的代码块的需求，但是很多生成框架并没有对代码块进行细致的分割和排布，
只是将基本块简单堆砌在一起。\par

为了解决这些问题，我们设计了高效的 RISCV 处理器瞬态执行漏洞测试程序生成框架，用于挖掘 RISCV 乱序处理器潜在的瞬态执行漏洞。
为了解决第一个问题，我们针对瞬态执行的场景设计了控制流、数据流的约束条件，
通过修改开源 RISCV 指令约束求解器 Razzle\cite{razzle}求解约束，生成需要的指令；
为了可以获得指令操作数的具体值，我们通过修改 spike 模拟器\cite{riscv-isa-sim}的扩展工作 cosim \cite{riscv-isa-cosim}
来生成指令执行结果求解器。
为了解决第二个问题，我们对于预设的瞬态窗口地址和触发瞬态窗口的指令有针对性地生成训练代码。
为了提高训练代码的训练能力，我们对训练代码进行地址敏感的代码排布，并为硬件引入了可切换内存单元，
使得训练代码和被训练代码可以共用物理地址。为了解决第三个问题，生成框架将瞬态执行涉及到的主体代码根据语义细分为三个阶段十个功能块，
为了提高各个功能块之间的协同工作能力，生成框架对代码块的操作数、地址等进行约束和匹配，以提高瞬态执行攻击的成功率。\par

该 RISCV 处理器的瞬态执行漏洞高效测试程序生成框架，最终可以支持物理态、内核态、用户态的执行，
支持虚拟地址和物理地址的执行，支持 rv64imafdc 的全集和 zicsr 扩展的子集\cite{riscv-isa-manual-all}。
该生成测试框架可以在 4 小时内找到 166 个 boom 处理器的完整 PoC，
覆盖 15 种瞬态窗口类型和至少 2 种侧信道，对于给定的窗口类型和侧信道类型可以在分钟的时间量级内找到 PoC，
远快于 SpecDoctor\cite{hur2022specdoctor} 等随机生成框架的小时级别。\par

总之，本文做出了以下贡献：\par

\begin{enumerate}
    \item 我们提出并解决了现有瞬态执行漏洞测试程序生成框架存在的三个问题：缺少数据流、控制流的约束，缺少训练代码的生成，
缺少代码块之间的语义分割和协同配合。并用实验证明，解决这些问题后，瞬态漏洞挖掘的性能得到了显著提高。\par
    \item 我们设计实现了一种新的高效的 RISCV 处理器瞬态执行漏洞测试程序生成框架，
并根据瞬态执行漏洞的语义设计了精细的代码块组织模板，可以在真实处理器中发现 RISCV 的瞬态执行漏洞
和瞬态执行攻击 PoC，且与 SpecDoctor 等随机生成框架相比，漏洞挖掘效率得到显著提高。\par
    \item 我们将该瞬态执行漏洞测试程序应用于开源的 boom 处理器，在四个小时内找到 166 个 boom 处理器的完整 PoC，
覆盖 15 种瞬态窗口类型和至少 2 种侧信道，证明了该生成框架可以找到真实处理器的 bug，具有现实意义。\par
\end{enumerate}


